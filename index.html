<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã—Ö –∞—Ç–∞–∫ –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –ø–∏—Å—å–º–∞—Ö</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>SecureMail ‚Äî –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ–¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏—à–∏–Ω–≥—É</h1>
      <p class="subtitle">–î–∏–ø–ª–æ–º–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø ‚Äî –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞–Ω—Ç–∏—Ñ–∏—à–∏–Ω–≥–æ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∫</p>
    </div>
  </header>

  <nav class="top-nav container" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <button onclick="renderInbox()" id="btn-inbox">üì• –í—Ö–æ–¥—è—â–∏–µ</button>
    <button onclick="showCompose()" id="btn-compose">‚úâÔ∏è –ù–æ–≤–æ–µ –ø–∏—Å—å–º–æ</button>
    <button onclick="showSettings()" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–∏—Å—å–º–∞–º..." oninput="renderInbox()" />
  </nav>

  <main class="container" id="content">
    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ -->
  <div id="linkWarning" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-inner">
      <h3>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å—Å—ã–ª–∫–µ</h3>
      <p id="linkWarningText"></p>
      <div class="modal-actions">
        <button onclick="closeWarning()">–û—Ç–º–µ–Ω–∞</button>
        <a id="continueLink" href="#" target="_blank" rel="noreferrer noopener"><button class="danger">–ü–µ—Ä–µ–π—Ç–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ</button></a>
      </div>
    </div>
  </div>

  <footer class="site-footer container">
    <small>¬© 2025 –î–∏–ø–ª–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –†—ã–º—Ç–∞–π –ê–Ω–µ–ª—å. –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –≤ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö.</small>
  </footer>

  <script>
    /* ---------- Demo data ---------- */
    const emails = [
      {
        id: 1,
        from: 'no-reply@yourbank.com',
        subject: '–í–∞—à —Å—á—ë—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
        date: '2025-10-24',
        body: '–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–ª–∞—Ç—ë–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: <a href="https://secure-yourbank.login.verify.example.com/confirm">https://secure-yourbank.login.verify.example.com/confirm</a>'
      },
      {
        id: 2,
        from: 'friend.best@gmail.com',
        subject: '–ü–æ—Å–º–æ—Ç—Ä–∏ —ç—Ç–æ —Ñ–æ—Ç–æ',
        date: '2025-10-22',
        body: '–ü—Ä–∏–≤–µ—Ç! –í–æ—Ç —Å—Å—ã–ª–∫–∞: <a href="http://93.184.216.34/album.jpg">http://93.184.216.34/album.jpg</a>'
      },
      {
        id: 3,
        from: 'it-support@company.example.com',
        subject: 'Password reset required',
        date: '2025-10-20',
        body: 'Password reset requested. Click: <a href="https://attacker.example.com/reset">https://attacker.example.com/reset</a>'
      },
      {
        id: 4,
        from: 'news@newsletter.example.com',
        subject: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞',
        date: '2025-10-19',
        body: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É —Ä–∞—Å—Å—ã–ª–∫—É! –ù–æ–≤–∏–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏.'
      }
    ];

    let currentEmailId = null;

    /* ---------- Heuristic detection ---------- */
    function detectPhishing(text = '', from = '') {
      const reasons = [];
      let score = 0;
      const lower = String(text).toLowerCase();

      const urgentWords = ['urgent','—Å—Ä–æ—á–Ω–æ','verify','password','login','–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ','–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ','action required'];
      for (const w of urgentWords) if (lower.includes(w)) { score += 15; reasons.push('–°—Ä–æ—á–Ω—ã–π/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–Ω—ã–π —Ç–æ–Ω'); }

      const linkRegex = /https?:\/\/[^\s'"]+/ig;
      const links = (text.match(linkRegex) || []);
      for (const l of links) {
        try {
          const url = new URL(l);
          if (/^\d+\.\d+\.\d+\.\d+$/.test(url.hostname)) { score += 25; reasons.push('–°—Å—ã–ª–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP-–∞–¥—Ä–µ—Å'); }
          const senderDomain = (from || '').split('@')[1] || '';
          if (senderDomain && !url.hostname.includes(senderDomain) && !url.hostname.endsWith('google.com')) {
            score += 20; reasons.push('–î–æ–º–µ–Ω —Å—Å—ã–ª–∫–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–æ–º–µ–Ω–æ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è');
          }
        } catch (e) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
          score += 10;
          reasons.push('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –≤ —Ç–µ–ª–µ –ø–∏—Å—å–º–∞');
        }
      }

      if (score > 100) score = 100;
      return { score, reasons: Array.from(new Set(reasons)), links };
    }

    /* ---------- Render functions ---------- */
    function renderInbox() {
      const q = (document.getElementById('search').value || '').toLowerCase();
      const list = emails
        .filter(e => (e.from + ' ' + e.subject + ' ' + e.body).toLowerCase().includes(q))
        .map(e => {
          const det = detectPhishing(e.body, e.from);
          const riskClass = det.score > 50 ? 'risk-high' : (det.score > 20 ? 'risk-medium' : 'risk-low');
          return `
            <article class="email-item ${riskClass}" onclick="openEmail(${e.id})" aria-labelledby="sub-${e.id}">
              <div class="email-meta">
                <div class="avatar">${(e.from && e.from[0]) ? e.from[0].toUpperCase() : '?'}</div>
                <div>
                  <div id="sub-${e.id}" class="email-subject">${escapeHtml(e.subject)}</div>
                  <div class="email-from">${escapeHtml(e.from)} ‚Ä¢ ${escapeHtml(e.date)}</div>
                </div>
              </div>
              <div class="email-risk">Risk: ${det.score}%</div>
            </article>
          `;
        }).join('');
      document.getElementById('content').innerHTML = `<h2>–í—Ö–æ–¥—è—â–∏–µ</h2><div class="inbox-list">${list || '<p>–ü—É—Å—Ç–æ</p>'}</div>`;
    }

    function openEmail(id) {
      currentEmailId = id;
      const mail = emails.find(x => x.id === id);
      if (!mail) { document.getElementById('content').innerHTML = '<p>–ü–∏—Å—å–º–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'; return; }
      const det = detectPhishing(mail.body, mail.from);
      document.getElementById('content').innerHTML = `
        <article class="mail-view">
          <header>
            <h2>${escapeHtml(mail.subject)}</h2>
            <div class="mail-from"><strong>–û—Ç:</strong> ${escapeHtml(mail.from)} <span class="dot">‚Ä¢</span> ${escapeHtml(mail.date)}</div>
          </header>
          <section class="mail-body">${mail.body}</section>
          <footer class="mail-actions">
            <div class="detected ${det.score > 50 ? 'danger' : (det.score > 20 ? 'warn' : 'ok')}">
              <strong>Phishing score:</strong> ${det.score}% ${det.reasons.length ? ' ‚Äî ' + det.reasons.join('; ') : ''}
            </div>
            <div class="buttons">
              <button onclick="renderInbox()">–ù–∞–∑–∞–¥</button>
              <button onclick="markPhishing(${id})" class="danger">Report phishing</button>
            </div>
          </footer>
        </article>
      `;
      attachLinkHandlers();
    }

    function showCompose() {
      document.getElementById('content').innerHTML = `
        <h2>–ù–æ–≤–æ–µ –ø–∏—Å—å–º–æ</h2>
        <form id="composeForm" onsubmit="sendCompose(event)">
          <label>–ö–æ–º—É</label><input type="email" id="composeTo" required placeholder="example@domain.com">
          <label>–¢–µ–º–∞</label><input id="composeSubject" required>
          <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label><textarea id="composeBody" rows="8" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞..."></textarea>
          <div class="compose-actions">
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å </button>
            <button type="button" onclick="renderInbox()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      `;
    }

    function showSettings() {
      document.getElementById('content').innerHTML = `
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
        <div class="settings">
          <label><input type="checkbox" id="optAutoDetect" checked> –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Å—ã–ª–æ–∫</label>
          <p class="small">–í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è SPF/DKIM/DMARC, URL sandboxes –∏ ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã.</p>
        </div>
      `;
    }

    /* ---------- Helpers & link handling ---------- */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function attachLinkHandlers() {
      const mailBody = document.querySelector('.mail-body');
      if (!mailBody) return;
      const links = mailBody.querySelectorAll('a[href]');
      links.forEach(a => {
        a.setAttribute('data-href', a.href);
        try {
          const url = new URL(a.href);
          a.setAttribute('title', '–î–æ–º–µ–Ω: ' + url.hostname);
        } catch(e) { a.setAttribute('title', a.href); }

        a.addEventListener('click', function(ev) {
          ev.preventDefault();
          const href = this.getAttribute('data-href');
          const mail = emails.find(x => x.id === currentEmailId) || {};
          const det = detectPhishing(mail.body, mail.from);
          let linkSuspicious = false;
          try {
            const url = new URL(href);
            const senderDomain = (mail.from || '').split('@')[1] || '';
            if (/^\d+\.\d+\.\d+\.\d+$/.test(url.hostname)) linkSuspicious = true;
            if (senderDomain && !url.hostname.includes(senderDomain)) linkSuspicious = true;
          } catch (e) { linkSuspicious = true; }

          if (det.score > 30 || linkSuspicious) {
            const text = linkSuspicious ? '–°—Å—ã–ª–∫–∞ –∫–∞–∂–µ—Ç—Å—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π (–¥–æ–º–µ–Ω –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏–ª–∏ —ç—Ç–æ IP).' : '–ü–∏—Å—å–º–æ –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫–∏–π phishing score.';
            document.getElementById('linkWarningText').innerText = text + '\\n–°—Å—ã–ª–∫–∞: ' + href;
            document.getElementById('continueLink').setAttribute('href', href);
            document.getElementById('linkWarning').style.display = 'flex';
            document.getElementById('linkWarning').setAttribute('aria-hidden', 'false');
          } else {
            window.open(href, '_blank', 'noopener');
          }
        });
      });
    }

    function closeWarning() {
      document.getElementById('linkWarning').style.display = 'none';
      document.getElementById('linkWarning').setAttribute('aria-hidden', 'true');
    }

    function markPhishing(id) {
      alert('–ü–∏—Å—å–º–æ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ñ–∏—à–∏–Ω–≥. –í –¥–∏–ø–ª–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç–µ: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ SOC/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ).');
      renderInbox();
    }

    
function sendCompose(ev) {
  ev.preventDefault();
  const to = document.getElementById('composeTo').value;
  const subj = document.getElementById('composeSubject').value;
  const body = document.getElementById('composeBody').value;

  fetch('/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      to: to,
      subject: subj,
      message: body
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      alert('‚úÖ ' + data.message);
    } else {
      alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
    }
  })
  .catch(err => alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + err));
}



    /* ---------- Init ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      renderInbox();
    });
  </script>
</body>
</html>

